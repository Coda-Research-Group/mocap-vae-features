#!/usr/bin/perl

use strict;

# Adapted from Vlastislav Dohnal
# CHANGES: in the output every ; is replaced by ,

# Converts objects from MESSIF format to single line vector for ELKI
# If input object is a metaobject, the first dimension of ELKI output is the number of subobjects

# Input:
# #objectKey messif.objects.keys.AbstractObjectKey 3136_100_1245_236_0
# 8;mcdr.objects.ObjectMocapPose
# 0.0, 0.0, 0.0; 1.3196042, -1.9361438, 0.9896419; 1.6738738, -8.990025, 2.7741618; 2.5750217, -16.384193, 1.0633717; 1.8688039, -17.829922, 3.111283; 1.4298456, -17.554525, 4.269519; -1.6263283, -1.6648564, 0.9470694; -1.5868261, -8.820924, 1.891408; -0.7740273, -16.029102, -0.8558862; -2.1413271, -17.210587, 1.0418658; -2.837081, -17.314205, 2.1093907; -0.103834495, 2.488555, 0.23479207; -0.34361604, 4.91786, 0.8522922; -0.604733, 7.3408093, 1.5964198; -0.7262408, 8.863613, 2.0480928; -0.49984485, 10.432776, 1.9868846; -0.671891, 12.03174, 1.7047648; 3.2883973, 9.017949, 1.4445848; 4.2963767, 4.1905127, 1.9766765; 3.860541, 0.9816413, 2.8270407; 3.641881, -0.62266374, 3.2523706; 3.6167645, -1.2050753, 4.258589; 3.6020033, -1.7716029, 5.0054708; 3.294019, -1.7179652, 3.9502149; -4.7227826, 7.6918507, 1.4408923; -5.674539, 3.2186508, -0.41530955; -4.3296204, 0.41962934, 0.43168098; -3.6571617, -0.97987974, 0.85517555; -4.106847, -2.1573567, 0.8771699; -4.3526335, -3.142249, 0.92736715; -3.6234314, -2.3280334, 1.4072275
# 0.0, 0.0, 0.0; 1.3497776, -1.911552, 0.9967292; 1.9054692, -8.981312, 2.6631482; 2.8026161, -16.27206, 0.5530019; 2.2243896, -17.833471, 2.5556178; 1.8426163, -17.701788, 3.7585092; -1.6000313, -1.6863269, 0.95385194; -1.2872338, -8.869372, 1.5931141; -0.7091468, -16.039652, -1.3084412; -1.9441576, -17.17217, 0.7062614; -2.5594633, -17.3107, 1.8182989; -0.26665592, 2.4860263, 0.08592105; -0.60719895, 4.9436026, 0.51565933; -0.80413395, 7.413533, 1.1100094; -0.9110265, 8.934167, 1.5725584; -0.75384414, 10.510506, 1.484665; -1.0143006, 12.102614, 1.2332067; 2.8032799, 9.208159, -0.2159617; 4.8645873, 5.5448565, -2.8493068; 6.1646113, 2.6117017, -3.8066297; 6.8145533, 1.1458536, -4.287647; 7.8673463, 0.69290197, -4.4845505; 8.66103, 0.24412724, -4.70289; 7.593999, 0.07044543, -4.4965506; -4.829226, 7.601115, 2.0423157; -5.862006, 3.2024384, 0.05589831; -4.257144, 0.47890615, 0.66212493; -3.4547138, -0.88285804, 0.9652387; -3.8360655, -2.084332, 0.9516977; -4.0233903, -3.0831625, 0.9655077; -3.3163207, -2.2509284, 1.4475738
# ...
# 0.0, 0.0, 0.0; 1.3639977, -1.8948697, 1.009147; 1.8620794, -8.970651, 2.668208; 2.6816711, -16.24096, 0.45834947; 1.990531, -17.781782, 2.4410272; 1.5752072, -17.534597, 3.6142468; -1.5873904, -1.6915017, 0.9657355; -1.161748, -8.886224, 1.3625238; -0.6840584, -16.02407, -1.6356516; -2.002843, -17.038347, 0.3889284; -2.6470838, -17.183977, 1.4835356; -0.32619828, 2.4796298, -0.062003344; -0.8119334, 4.9432273, 0.12527177; -1.1974932, 7.441087, 0.44874045; -1.2902219, 8.960972, 0.91677225; -1.198349, 10.544163, 0.86837506; -1.5561074, 12.130696, 0.7241633; 1.8195821, 9.375265, -1.820297; 5.5692744, 8.764414, -5.0093336; 8.744314, 8.215767, -5.9192967; 10.3309765, 7.9409714, -6.377013; 11.117928, 8.673137, -6.820804; 11.807297, 9.168726, -7.2185035; 11.600094, 8.201178, -6.736619; -4.948867, 7.361416, 2.1884525; -6.232411, 2.9125924, 0.47926128; -4.4314055, 0.25517154, 0.7142397; -3.5309038, -1.0735372, 0.83172905; -3.87738, -2.2850204, 0.86934733; -4.0335107, -3.288592, 0.9069041; -3.2877836, -2.4367933, 1.2854265

# Output:
# 8 0.0, 0.0, 0.0; 1.3196042, -1.9361438, 0.9896419; 1.6738738, -8.990025, .... 0.0, 0.0, 0.0; 1.3497776, -1.911552, 0.9967292; 1.9054692, ... .... ; -3.2877836, -2.4367933, 1.2854265 label3136_100_1245_236_0

my $id;
my $obj;
my $subobj_cnt = 0;
while (<>) {
	chomp;
	#next if /^\s*[0-9]+;\S+/;	# ignore meta object class names
	if (/^\s*([0-9]+);\S+/) {
		$subobj_cnt = $1;
		next;
	}
	if (/^#objectKey\s+(\S*)\s+(\S*)\r?\n?/) {
		my $newid = $2;
		# print "DBG: $1 $2 - prev $id, $obj\n";
		if (defined $obj) {
			# print "ID=", $id, $obj, "\n";
			print $subobj_cnt, " ", $obj, " label".$id, "\n";
			$obj = undef;
		}
		$id = $newid;
		next;
	}
	s/[\r\n]//g;
	# print "DBG: $_\n";
	# CHANGED: every ; is replaced by ,
	$_ =~ s/\;/\,/g;
	if (defined $obj) {
		$obj .= " " . $_;
	} else {
		$obj = $_;
	}
}
if (defined $obj) {
	# print "ID=", $id, $obj, "\n";
	print $subobj_cnt, " ",$obj, " label".$id, "\n";
	$obj = undef;
}
